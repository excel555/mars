<style>
	#pro_code_suggest { font-size: 12px }
	#pro_code_suggest .badge{ background-color: #f0ad4e; }
</style>
<div class="panel panel-default">
	<div class="panel-body">
		<form class="form-horizontal from-body">
			<div class="form-group form-group-sm">
				<label class="col-sm-2 control-label"><{$keyObj.name}>仓位</label>
				<div class="col-sm-5">
					<select name="warehouse_id" id="warehouse" class="form-control">
						<option value="">--请选择操作的仓位--</option>
						<{foreach $warehouse as $k=>$v}>
						<option value="<{$v['id']}>"><{$v['name']}></option>
						<{/foreach}>
					</select>
				</div>
			</div>

			<div class="form-group form-group-sm">
				<label class="col-sm-2 control-label"><{$keyObj.name}>备注</label>
				<div class="col-sm-5">
					<input type="text" class="form-control" id="name" name="name"/>
				</div>
			</div>

			<{if $key == 'allocate'}>
            <div class="form-group form-group-sm">
                <label class="col-sm-2 control-label">供应商</label>
                <div class="col-sm-5">
                    <input type="text" placeholder="供应商ID" class="form-control" id="supplier_id" name="supplier_id"/>
                    <div id="supplier_suggest"></div>
                </div>
                <div class="col-sm-5">
                    <span class="help-block" id="supplier_name"></span>
                </div>
            </div>

			<div class="form-group form-group-sm">
				<label class="col-sm-2 control-label">新设备数量</label>
				<div class="col-sm-5">
					<input type="text" value="0" class="form-control" id="equipment_num" name="equipment_num"/>
				</div>
			</div>

			<div class="form-group form-group-sm">
				<label for="start_date" class="col-sm-2 control-label col-form-label">时间段</label>
				<div class="col-sm-10 form-inline">
					<div class="input-group">
						<input type="text" id="start_date" value="<{$start_date}>" name="start_date" readonly class="form-control">
						<span class="input-group-btn">
                            <button class="btn btn-default btn-sm btn-clear" type="button"><i class="glyphicon glyphicon-remove"></i></button>
                        </span>
					</div>
					<span>-</span>
					<div class="input-group">
						<input type="text" id="end_date" value="<{$end_date}>" name="end_date" readonly class="form-control">
						<span class="input-group-btn">
                            <button class="btn btn-default btn-sm btn-clear" type="button"><i class="glyphicon glyphicon-remove"></i></button>
                        </span>
					</div>
				</div>
			</div>

			<div class="form-group form-group-sm">
				<label class="col-sm-2 control-label">标签</label>
				<div class="col-sm-5">
					<select name="tag" id="tag" class="form-control">
						<option value="0">--请选择--</option>
						<{foreach $tag as $k=>$v}>
						<option value="<{$v.id}>"><{$v.name}></option>
						<{/foreach}>
					</select>
				</div>
			</div>
			<{elseif $key == 'stock_in'}>
			<div class="form-group form-group-sm">
				<label class="col-sm-2 control-label"><span style="color:red">*</span>入库类型</label>
				<div class="col-sm-10">
					<{foreach $keyObj['type'] as $k =>$v}>
					<label class="radio-inline">
						<input type="radio" name="type" value="<{$k}>"> <{$v}>
					</label>
					<{/foreach}>
				</div>
			</div>
			<div class="form-group form-group-sm">
				<label class="col-sm-2 control-label">单号</label>
				<div class="col-sm-5">
					<input type="text" value="" class="form-control" id="order_name" name="order_name"/>
				</div>
			</div>
			<{elseif $key == 'stock_out'}>
			<div class="form-group form-group-sm">
				<label class="col-sm-2 control-label"><span style="color:red">*</span>出库类型</label>
				<div class="col-sm-10">
					<{foreach $keyObj['type'] as $k =>$v}>
					<label class="radio-inline">
						<input type="radio" name="type" value="<{$k}>"> <{$v}>
					</label>
					<{/foreach}>
				</div>
			</div>
			<div class="form-group form-group-sm">
				<label class="col-sm-2 control-label"><span style="color:red">*</span>是否贴标</label>
				<div class="col-sm-5">
					<label class="radio-inline">
						<input type="radio" name="is_label" value="1"> 是
					</label>
					<label class="radio-inline">
						<input type="radio" name="is_label" value="0"> 否
					</label>
				</div>
			</div>
			<div class="form-group form-group-sm">
				<label class="col-sm-2 control-label">补货总单号</label>
				<div class="col-sm-5">
					<input type="text" value="" class="form-control" id="shipping_batch" name="shipping_batch"/>
				</div>
			</div>
			<{elseif $key == 'lose_report'}>
			<div class="form-group form-group-sm">
				<label class="col-sm-2 control-label"><span style="color:red">*</span>报损类型</label>
				<div class="col-sm-5">
					<{foreach $keyObj['type'] as $k =>$v}>
					<label class="radio-inline">
						<input type="radio" name="type" value="<{$k}>"> <{$v}>
					</label>
					<{/foreach}>
				</div>
			</div>
			<div class="form-group form-group-sm">
				<label for="start_date" class="col-sm-2 control-label col-form-label">时间段</label>
				<div class="col-sm-10 form-inline">
					<div class="input-group">
						<input type="text" id="start_date" value="<{$start_date}>" name="start_date" readonly class="form-control">
						<span class="input-group-btn">
                            <button class="btn btn-default btn-sm btn-clear" type="button"><i class="glyphicon glyphicon-remove"></i></button>
                        </span>
					</div>
					<span>-</span>
					<div class="input-group">
						<input type="text" id="end_date" value="<{$end_date}>" name="end_date" readonly class="form-control">
						<span class="input-group-btn">
                            <button class="btn btn-default btn-sm btn-clear" type="button"><i class="glyphicon glyphicon-remove"></i></button>
                        </span>
					</div>
				</div>
			</div>
			<{/if}>

			<div class="form-group form-group-sm">
				<label class="col-sm-2 control-label"><{$keyObj.name}>明细</label>
				<div class="col-sm-5">
					<div class="input-group">
						<input type="text" class="form-control" autocomplete="off" id="pro_code" placeholder="69码|商品唯一编码">
						<span class="input-group-btn">
                            <button class="btn btn-default btn-sm btn-clear" type="button"><i class="glyphicon glyphicon-remove"></i></button>
                            <button class="btn btn-success btn-sm btn-pro-code" type="button"><i class="glyphicon glyphicon-plus"></i></button>
                        </span>
					</div>
					<ul class="list-group" id="pro_code_suggest"></ul>
				</div>
				<div class="col-sm-5 control-label">
					<div class="itemTotal"></div>
				</div>
			</div>
		</form>
		<div class="row">
			<div class="form-group">
				<label class="col-sm-2 control-label text-right"></label>
				<div class="col-sm-10">
					<table id="tableData" class="table table-striped"></table>
				</div>
			</div>
		</div>
	</div>
</div>

<br/>
<br/>
<br/>
<nav class="navbar navbar-default navbar-fixed-bottom">
	<div class="form-inline">
		<div class="col-md-12 form-control-static tool-bottom text-center">
			<{if $key != 'check'}>
			<span class="btn btn-info btn-init">导入默认商品</span>
			<{/if}>
			<span class="btn btn-success btn-save">提交</span>
		</div>
	</div>
</nav>

<link href="/assets/bootstrap/css/bootstrap-editable.css" rel="stylesheet"/>
<script src="/assets/bootstrap/js/bootstrap-editable.min.js"></script>
<script src="/assets/bootstrap/js/bootstrap-table-editable.js" type='text/javascript'></script>
<script type="text/javascript">
    (function () {
        var key = '<{$key}>';
        var name = '<{$keyObj.name}>';
        var table = $('#tableData');
        var warehouse = $('#warehouse');
        var code = $('#pro_code');
        var toolBottom = $('.tool-bottom');
        var form = $('.from-body');
        var columns = [
            {field: 'product_id', title: '商品ID'},
            {field: 'product_name', title: '商品名称'},
            {field: 'pro_code', title: '编码'}
        ];

        if (key == 'stock_in') {
            columns.push({
                field: 'stock_onway', title: '在途数量',
                editable: {
                    type: 'text',
                    validate: function (v) {
                        if (!/^\d+$/.test(v)) {
                            return '格式错误, 只能为正整数';
                        }
                    }
                }
            });
        } else if (key == 'check') {
            columns.push(
                {
                    field: key + '_stock_before', title: name + '前库存量'
                },
                {
                    field: 'stock_onway', title: '在途数量',
                    editable: {
                        type: 'text',
                        validate: function (v) {
                            if (!/^\d+$/.test(v)) {
                                return '格式错误, 只能为正整数';
                            }
                        }
                    }
                }
            );
        } else if (key == 'allocate') {
            columns.push(
                {
                    field: 'supplier_box_qty', title: '箱入数'
                },
                {
                    field: 'purchase_price', title: '进价',
                    editable: {
                        type: 'text',
                        validate: function (v) {
                            if (!/^[0-9.]+$/.test(v)) {
                                return '格式错误, 只能为数字';
                            }
                        }
                    }
                }
            );
        }

        columns.push({
                field: key + '_num', title: name + '量',
                editable: {
                    type: 'text',
                    validate: function (v) {
                        if (!/^\d+$/.test(v)) {
                            return '格式错误, 只能为正整数';
                        }
                    }
                }
            },
            {
                field: 'operation', title: '操作', align: 'center',
                formatter: function (value, row, index) {
                    return ['<a data-pid="' + row.product_id + '" class="btn btn-xs btn-danger btn-del">删除</a>'].join('');
                }
            });

        $('#start_date,#end_date').datetimepicker({
            language: 'zh', //汉化
            autoclose: 1,
            format: 'yyyy-mm-dd',
            minView: 2
        });

        function tableData() {
            return table.bootstrapTable('getData');
        }

        function checkRow(rows, id) {
            var ins = [];
            var existed = [];
            var TID = [];
            $.each(tableData(), function () {
                TID.push(this.product_id);
            });

            $.each(rows, function () {
                if ($.inArray(this.product_id, TID) < 0) {
                    ins.push(this);
                } else {
                    existed.push(this[id]);
                }
            });

            return {ins: ins, existed: existed};
        }

        function formData() {
            var p = {};
            $.each(form.serializeArray(), function () {
                if (this.name.indexOf('[]') > -1) {
                    if (p[this.name] === undefined) {
                        p[this.name] = [];
                    }
                    p[this.name].push(this.value);
                } else {
                    p[this.name] = this.value;
                }
            });
            return p;
        }


        table.bootstrapTable({
            columns: columns,
            uniqueId: 'product_id',
            onPostBody: function (data) {
                data = data || [];
                var qty = 0;
                var stock_onway = 0;
                $.each(data, function () {
                    qty += parseInt(this[key + '_num']);
                    stock_onway += parseInt(this['stock_onway']);
                });
                var txt = ' 商品数量: <span class="label label-warning">' + data.length + '</span> ';
                if (key == 'stock_in' || key == 'check') {
                    txt += '在途数量: <span class="label label-danger" data-field="stock_onway">' + stock_onway + '</span> ';
                }
                txt += name + '量: <span class="label label-primary" data-field="' + key + '_num">' + qty + '</span> ';
                $('.itemTotal').html(txt);
            },
            onEditableShown: function (field, row, $el, editable) {
                editable.input.$clear.trigger('click');
            },
            onEditableSave: function (field, row, oldValue, $el) {
                var obj = $('.itemTotal').find('[data-field=' + field + ']');
                obj.html(parseInt(obj.html() || 0) - parseInt(oldValue) + parseInt(row[field]));
                if ($el.parents('tr:eq(0)').data('index') < 1) {
                    code.focus();
                }
            }
        });

        form.on('click', '.btn-pro-code', function (e) {
            var _this = $(this);
            if (_this.attr('loading') == 1 || code.val().trim() == '') {
                return;
            }
            _this.attr('loading', 1);
            var data = formData();
            data['pro_code'] = code.val().trim();
            $.ajax({
                url: '/warehouse/product/' + key,
                type: "POST",
                data: data,
                dataType: 'json',
                error: function () {
                    _this.attr('loading', 0);
                },
                success: function (resp) {
                    _this.attr('loading', 0);
                    if (resp.status != 'y') {
                        alert(resp.msg);
                        return;
                    }

                    var cr = checkRow(resp.data, 'pro_code');
                    table.bootstrapTable('prepend', cr.ins);
                    if (cr.existed.length > 0) {
                        alert(cr.existed.join(',') + '已经存在列表中');
                    }

                    var ecp = data['pro_code'].split(',');
                    if (resp.data.length == 0) {
                        alert(ecp.join(',') + '编码找不到对应的商品,请先绑定69码或唯一编码');
                        return;
                    }
                    var ecr = [];
                    var notFound = [];
                    $.each(resp.data, function () {
                        ecr.push(this.pro_code);
                    });

                    $.each(ecp, function () {
                        if (this && this != '' && $.inArray(this.trim(), ecr) < 0) {
                            notFound.push(this);
                        }
                    });
                    if (notFound.length > 0) {
                        alert(notFound.join(',') + '编码找不到对应的商品,请先绑定69码或唯一编码');
                        return;
                    }

                    if (cr.ins.length > 0) {
                        code.val('');
                        table.find('[data-name=' + key + '_num]').eq(0).trigger('click');
                    }
                }
            });
        }).on('keyup', '#pro_code', function (e) {
            var v = $(this).val().trim();
            var supplier_id = $('#supplier_id').length == 1 ? $('#supplier_id').val().trim() : 0;
            if (v == '') {
                $('#pro_code_suggest').html('');
                return;
            }
            // if(key == 'allocate' && supplier_id == ''){
            //     MessageBox.error('请选择供应商');
            //     return;
            // }
            if (e.keyCode == 13) {
                $('.btn-pro-code').trigger('click');
            } else if (v.indexOf(',') == -1 && !(/^[U]?\d+$/.test(v))) {
                $.ajax({
                    url: '/warehouse/product_suggest/',
                    type: "POST",
                    data: {keyword: v, key: key, supplier_id: supplier_id},
                    dataType: 'json',
                    success: function (resp) {
                        var li = [];
                        if (resp && resp.status == 'y') {
                            $.each(resp.data, function () {
                                if (this.serial_number) {
                                    li.unshift('<li class="list-group-item" data-code="' + this.serial_number + '">' + this.product_name + ' <span class="badge">' + this.serial_number + '</span></li>');
                                } else {
                                    li.push('<li class="list-group-item disabled" data-code="">' + this.product_name + '</li>')
                                }

                            });
                        }
                        $('#pro_code_suggest').html(li.join(''));
                    }
                });
            }
        }).on('click', function (e) {
            $('#pro_code_suggest').html('');
        }).on('click', '#pro_code_suggest li', function (e) {
            var pro_code = $(this).data('code');
            if (!pro_code || pro_code == '') {
                $('#pro_code').val('');
                alert('请先绑定69码或唯一编码: ' + $(this).text());
                return;
            }
            $('#pro_code').val(pro_code);
            $('.btn-pro-code').trigger('click');

        }).on('click', '.btn-clear', function (e) {
            $(this).parent().prev().val('');
        });

        table.on('click', '.btn-del', function (e) {
            table.bootstrapTable('remove', {
                field: 'product_id',
                values: [String($(this).data('pid'))]
            });
        });

        toolBottom.on('click', '.btn-save', function (e) {
            var _this = $(this);
            var data = formData();
            if (_this.attr('loading') == 1) {
                return;
            }
            _this.attr('loading', 1);
            data['products'] = JSON.stringify(tableData());
            $.ajax({
                url: '/warehouse/order_save/' + key,
                type: "POST",
                data: data,
                dataType: 'json',
                error: function () {
                    _this.attr('loading', 0);
                },
                success: function (resp) {
                    _this.attr('loading', 0);

                    if (resp.status != 'y') {
                        alert(resp.msg);
                        return;
                    }
                    alert('提交成功');
                    window.location.href = '/warehouse/order_list/' + key;

                }
            });
        }).on('click', '.btn-init', function (e) {
            var _this = $(this);
            if (_this.attr('loading') == 1) {
                return;
            }
            var data = formData();
            if (tableData().length > 0 && !window.confirm('初始化会清空商品列表，请确认!')) {
                return;
            }
            _this.attr('loading', 1);
            table.bootstrapTable('removeAll');
            table.bootstrapTable('showLoading');
            $.ajax({
                url: '/warehouse/order_init_products/' + key,
                type: "POST",
                data: data,
                dataType: 'json',
                error: function () {
                    _this.attr('loading', 0);
                },
                success: function (resp) {
                    _this.attr('loading', 0);
                    table.bootstrapTable('hideLoading');
                    if (resp.status != 'y') {
                        alert(resp.msg);
                        return;
                    }
                    table.bootstrapTable('load', resp.data);
                }
            });

        });
        $('body').on('keyup', '[name="supplier_id"]', function(e){
            var v = $(this).val().trim();
                if (v == '') {
                    $('#supplier_suggest').html('');
                    return;
                }
                $.ajax({
                        url: '/warehouse/supplier_suggest/',
                        type: "POST",
                        data: {keyword: v},
                        dataType: 'json',
                        success: function (resp) {
                            var li = [];
                            if (resp && resp.status == 'y') {
                                $.each(resp.data, function () {
                                    if (this.code) {
                                        li.unshift('<li class="list-group-item" data-supplier-id="' + this.id + '">' + this.name + ' <span class="badge">' + this.code + '</span></li>');
                                    } else {
                                        li.push('<li class="list-group-item" data-supplier-id="' + this.id + '">' + this.name + '</li>')
                                    }

                                });
                            }
                            $('#supplier_suggest').html(li.join(''));
                        }
                    });
        }).on('click', '#supplier_suggest li', function(){
            $('[name="supplier_id"]').val($(this).data('supplierId'));
            $('#supplier_name').text($(this).text());
        }).on('click', function(){
            $('#supplier_suggest').html('');
        });
    })();
</script>