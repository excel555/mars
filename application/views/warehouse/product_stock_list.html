<style type="text/css">
	.pagination-detail { padding-left: 10px }

	.pagination { padding-right: 10px }

	table,.panel {
		font-size: 12px;
	}
	table img{
		border-radius: 5px;
	}

	.dropdown-menu {min-width: 110px; font-size: 12px}
	.dropdown-submenu {
		position: relative;
	}
	.dropdown-submenu > .dropdown-menu {
		top: 0;
		left: 100%;
		margin-top: -6px;
		margin-left: -1px;
		-webkit-border-radius: 0 6px 6px 6px;
		-moz-border-radius: 0 6px 6px;
		border-radius: 0 6px 6px 6px;
	}
	.dropdown-submenu:hover > .dropdown-menu {
		display: block;
	}
	.dropdown-submenu > a:after {
		display: block;
		content: " ";
		float: right;
		width: 0;
		height: 0;
		border-color: transparent;
		border-style: solid;
		border-width: 5px 0 5px 5px;
		border-left-color: #ccc;
		margin-top: 5px;
		margin-right: -10px;
	}
	.dropdown-submenu:hover > a:after {
		border-left-color: #fff;
	}
	.dropdown-submenu.pull-left {
		float: none;
	}
	.dropdown-submenu.pull-left > .dropdown-menu {
		left: -100%;
		margin-left: 10px;
		-webkit-border-radius: 6px 0 6px 6px;
		-moz-border-radius: 6px 0 6px 6px;
		border-radius: 6px 0 6px 6px;
	}
	.panel .btn-warning .badge{
		color: #f0ad4e;
		background-color: #fff;
	}
	.panel .btn-danger .badge{
		color: #d9534f;
		background-color: #fff;
	}

</style><!--
<div style="position: relative">
	<div style="position: absolute; top: -50px; right: 0" class="btn btn-warning">缺货<span class="badge">42</span></div>
</div>-->
<div class="panel panel-default">
	<div class="panel-heading">
		<div class="pull-left toolbar">
			<a href="/warehouse/product_stock_log/" class="btn btn-sm btn-info">查看历史库存变化</a>
			<a href="/warehouse/product_stock_date_log/" class="btn btn-sm btn-warning">每日库存</a>
		</div>
		<div class="pull-right form-inline searchbar">
			<div class="form-group form-group-sm">滞留 <span class="label label-danger btn-retention">0</span></div>
			<div class="form-group form-group-sm">缺货 <span class="label label-primary btn-stock-warning">0</span></div>
			<div class="form-group form-group-sm">
				<select name="warehouse_id" id="warehouse" class="form-control">
					<option value="-1">-全部仓位-</option>
					<{foreach $warehouse as $k=>$v}>
					<option value="<{$v['id']}>"><{$v['name']}></option>
					<{/foreach}>
				</select>
			</div>
			<div class="form-group form-group-sm btn-group">
				<button class="btn btn-sm btn-default dropdown-toggle btn-prod-class" data-toggle="dropdown">
					目类: <span class="prod-class-text">全部</span><input name="class_id" type="hidden" value="" /> <span class="caret"></span>
				</button>
				<ul class="dropdown-menu" role="menu">
					<li><a href="javascript:;" data-value="">全部</a></li>
					<li role="presentation" class="divider"></li>
					<{foreach $product_class as $v1}>
					<li<{if $v1.son}> class="dropdown-submenu"<{/if}>>
					<a href="javascript:;" data-value="<{$v1.ids}>"><{$v1.name}></a>
					<{if $v1.son}>
					<ul class="dropdown-menu" role="menu">
						<{foreach $v1.son as $v2}>
						<li <{if $v2.son}> class="dropdown-submenu"<{/if}>>
						<a href="javascript:;" data-value="<{$v2.id}>"><{$v2.name}></a>
						</li>
						<{/foreach}>
					</ul>
					<{/if}>
					</li>
					<{/foreach}>
				</ul>
			</div>
			<div class="form-group form-group-sm">
				<select name="status" id="status" class="form-control">
					<option value="-1">-状态-</option>
					<option data-name="stock_warning" value="1">缺货</option>
					<option data-name="retention" value="1">滞留</option>
				</select>
			</div>
			<div class="form-group form-group-sm">
				<input type="text" class="form-control" name="name" placeholder="商品名称或商品编码">
			</div>
			<div class="form-group form-group-sm">
				<button type="button" class="btn btn-sm btn-default btn-search">查找</button>
				<a href="/warehouse/product_stock_list_export/" class="btn btn-sm btn-danger">导出实时库存</a>
			</div>
		</div>

		<div style="clear: both"></div>
	</div>
</div>
<table id="tableBody" class="table table-striped"></table>

<link href="/assets/bootstrap/css/bootstrap-editable.css" rel="stylesheet"/>
<script src="/assets/bootstrap/js/bootstrap-editable.min.js"></script>
<script src="/assets/bootstrap/js/bootstrap-table-editable.js" type='text/javascript'></script>

<script type="text/javascript">
    $(function () {
        var columns = [
            {field: 'product_id', title: '商品ID', width: 65},
            {field: 'pro_code', title: '商品编码', width: 120},
            {field: 'class_name', title: '商品类目', width: 100, sortable: true},
            {field: 'img_url', title: '图片', align: 'center', width: 30,formatter:function (value,row,index) {
                return value && value != '' ? '<img src="http://fdaycdn.fruitday.com/'+value+'" width="30"/>' : '';
            }},
            {field: 'product_name', title: '名称', formatter:function (value,row,index) {
                return row.product_name + '<br />' + (row.retention ? '<span class="label label-danger">' + row.retention + ' 天</span> ' : '')
                    + (row.stock_warning > 0 && parseInt(row.stock_warning) > parseInt(row.stock) ? ('<span class="label label-primary">' + (parseInt(row.stock_warning) - parseInt(row.stock)) + '</span>') : '');
            }},
            {field: 'warehouse_name', title: '仓位'},
            {field: 'volume', title: '规格'},
            {field: 'price', title: '售价', sortable: true},
            {field: 'purchase_price', title: '进价', sortable: true},
            {field: 'stock', title: '仓库库存', sortable: true},
            {field: 'stock_onway', title: '在途', sortable: true},
            {field: 'equipment_stock', title: '在售'},
            {field: 'stock_warning', title: '预警', editable: {
                type: 'text',
                validate: function (v) {
                    if (!/^\d+$/.test(v)) {
                        return '格式错误, 只能为正整数';
                    }
                }
            }
            },
            {
                field: 'operation', title: '操作', align: 'center',
                formatter: function (value, row, index) {
                    return ['<a href="/warehouse/product_stock_log/' + row.warehouse_id +'/' + row.product_id + '" class="btn btn-xs btn-info">查看log</a>'].join('');
                }
            }
        ];
        var table = $('#tableBody');
        table.bootstrapTable({
            url: '/warehouse/product_stock_list_data/',
            uniqueId: 'id',
            columns: columns,
            sidePagination: "server",
            queryParams: function queryParams(params) {
                $('.searchbar').find('input, select').each(function () {
                    var _this = $(this), _val = $.trim(_this.val()), _tagName = _this.get(0).tagName;
                    if ((_tagName == 'INPUT' && _val != '') || (_tagName == 'SELECT' && _val != '-1')) {
                        var name = $(this).find("option:selected").data('name') || $(this).data('name') || $(this).attr('name');
                        params[name] = _val;
                    }

                });
                return params;
            },
            onEditableShown: function (field, row, $el, editable) {
                editable.input.$clear.trigger('click');
            },
            onEditableSave: function (field, row, oldValue, $el) {
                $.ajax({
                    url: '/warehouse/product_stock_editable/',
                    type: "POST",
                    data: {field: field, row: row, old_value: oldValue},
                    dataType: 'json',
                    success: function (resp) {
                        var set = row;
                        if (resp.status != 'y') {
                            set[field] = oldValue;
                        }
                        table.bootstrapTable('updateByUniqueId', set);
                    }
                });
            },
            onLoadSuccess: function(data){
                if(data && data.notify !== undefined){
					$('.btn-stock-warning').text(data.notify.warning);
					$('.btn-retention').text(data.notify.retention);
                }
	        },
            pagination: true,
            pageSize: 10,
            pageList: [10, 25, 50, 100]
        });

        $('.btn-search').on('click', function () {
            table.bootstrapTable('refresh');
        });
        var btnProdClass = $('.btn-prod-class');
        var btnProdClassDM = $('.btn-prod-class').next('.dropdown-menu');
        console.log(btnProdClass,btnProdClassDM);
        btnProdClassDM.on('click', 'a', function () {
            btnProdClass.find('input').val($(this).data('value'))
            btnProdClass.find('.prod-class-text').text($(this).text())
        });
    });
</script>