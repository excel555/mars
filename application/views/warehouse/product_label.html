<style type="text/css">
	.pagination-detail { padding-left: 10px }

	.pagination { padding-right: 10px }

	table img {
		border-radius: 5px;
	}

	.panel .btn-warning .badge {
		color: #f0ad4e;
		background-color: #fff;
	}

	.panel .btn-danger .badge {
		color: #d9534f;
		background-color: #fff;
	}

	.list-group{ margin-bottom: 0}
	#pro_code_suggest { font-size: 12px }
	#pro_code_suggest .badge{ background-color: #f0ad4e; }

</style>
<div class="panel panel-default">
	<div class="panel-heading">
		<div class="pull-left toolbar">
			<span class="btn btn-sm btn-success btn-add">盘点标签</span>
		</div>
		<div class="pull-right form-inline searchbar">
			<div class="form-group form-group-sm">
				<select name="warehouse_id" class="form-control">
					<{foreach $warehouse as $v}>
					<option value="<{$v.id}>"><{$v.name}></option>
					<{/foreach}>
				</select>
			</div>
			<div class="form-group form-group-sm">
				<input type="text" class="form-control" name="name" placeholder="商品名称">
			</div>
			<div class="form-group form-group-sm">
				<button type="button" class="btn btn-sm btn-default btn-search">查找</button>
			</div>
			<div class="form-group form-group-sm">
				<button type="button" class="btn btn-sm btn-danger btn-export">导出</button>
			</div>
		</div>

		<div style="clear: both"></div>
	</div>
</div>
<table id="tableBody" class="table table-striped"></table>
<div class="modal fade">
	<div class="modal-dialog">
		<div class="modal-content"></div>
	</div>
</div>
<link href="/assets/bootstrap/css/bootstrap-editable.css" rel="stylesheet"/>
<script src="/assets/bootstrap/js/bootstrap-editable.min.js"></script>
<script src="/assets/bootstrap/js/bootstrap-table-editable.js" type='text/javascript'></script>

<script type="text/javascript">
    $(function () {
        var columns = [
            {field: 'product_id', title: '商品ID', width: 100},
            {field: 'product_name', title: '商品名称'},
            {field: 'stock', title: '仓库库存'},
            {field: 'preset_qty', title: '预估数量'},
            {field: 'qty', title: '可用数量'},
            {field: 'out_qty', title: '销售出库数量'},
            {field: 'miss_qty', title: '待生产'}
        ];
        var table = $('#tableBody'),
            modal = $('.modal'),
            modalContent = $('.modal-content'),
            btnAdd = $('.btn-add');


        table.bootstrapTable({
            url: '/warehouse/product_label_data/',
            uniqueId: 'product_id',
            columns: columns,
            sidePagination: "server",
            queryParams: function queryParams(params) {
                $('.searchbar').find('input, select').each(function () {
                    var _this = $(this), _val = $.trim(_this.val()), _tagName = _this.get(0).tagName;
                    if ((_tagName == 'INPUT' && _val != '') || (_tagName == 'SELECT' && _val != '-1')) {
                        var name = $(this).find("option:selected").data('name') || $(this).data('name') || $(this).attr('name');
                        params[name] = _val;
                    }

                });
                return params;
            },
            onEditableShown: function (field, row, $el, editable) {
                if(editable.input.$clear){
                    editable.input.$clear.trigger('click');
                }

            },
            onEditableSave: function (field, row, oldValue, $el) {
                $.ajax({
                    url: '/deliver_order/replenish_config_editable/',
                    type: "POST",
                    data: {field: field, row: row, old_value: oldValue},
                    dataType: 'json',
                    success: function (resp) {
                        var set = row;
                        if (resp.status != 'y') {
                            set[field] = oldValue;
                        }
                        table.bootstrapTable('updateByUniqueId', set);
                    }
                });
            },
            onLoadSuccess: function (data) {
                console.log(data);
            },
            //pagination: true,
            //pageSize: 10,
            //pageList: [10, 25, 50, 100]
        });

        $('.btn-search').on('click', function () {
            table.bootstrapTable('refresh');
        });
        $('.btn-export').on('click', function () {
            var params = [];
            $('.searchbar').find('input, select').each(function () {
                var _this = $(this), _val = $.trim(_this.val()), _tagName = _this.get(0).tagName;
                if ((_tagName == 'INPUT' && _val != '') || (_tagName == 'SELECT' && _val != '-1')) {
                    var name = $(this).find("option:selected").data('name') || $(this).data('name') || $(this).attr('name');
                    params.push(name + '=' + _val);
                }

            });
            window.location.href = '/warehouse/product_label_export/?'+params.join('&');
        });

        btnAdd.on('click', function () {
            modalContent.html('');
            $.ajax({
                url: '/warehouse/product_label_check',
                dataType: 'html',
                success: function (resp) {
                    modalContent.html(resp);
                    modal.modal('show');
                    modalContent.find('table').bootstrapTable({
                        url: '/warehouse/product_label_check_data/',
                        columns: [
                            {field: 'product_id', title: '商品ID'},
                            {field: 'product_name', title: '商品名称'},
                            {
                                field: 'qty', title: '数量',
	                            formatter: function(value, row){
                                    return value ? value : 0;
	                            },
                                editable: {
                                    type: 'text',
                                    validate: function (v) {
                                        if (!/^\d+$/.test(v)) {
                                            return '格式错误, 只能为正整数';
                                        }
                                    }
                                }
                            },
	                        {field: '_options', title: '操作', formatter: function (val,row) {
			                        return '<span class="btn btn-danger btn-xs btn-del">x</span>'
                                }}
                        ],
                        sidePagination: "server",
                        uniqueId: 'product_id',
                        onEditableShown: function (field, row, $el, editable) {
                            editable.input.$clear.trigger('click');
                        },
                        onEditableSave: function (field, row, oldValue, $el) {
                            $.ajax({
                                url: '/warehouse/product_label_check_editable/',
                                type: "POST",
                                data: {field: field, row: row, old_value: oldValue, warehouse_id: $('[name=warehouse_id]').val()},
                                dataType: 'json',
                                success: function (resp) {
                                    var set = row;
                                    if (resp.status != 'y') {
                                        set = oldValue;
                                    }
                                    table.bootstrapTable('updateByUniqueId', set);
                                    modalContent.find('#pro_code').focus();
                                }

                            });
                        }
                    });
                }

            });
        });


        function tableData() {
            return modalContent.find('table').bootstrapTable('getData');
        }


        function formData() {
            var p = {};
            $.each(modalContent.find('form').serializeArray(), function () {
                if (this.name.indexOf('[]') > -1) {
                    if (p[this.name] === undefined) {
                        p[this.name] = [];
                    }
                    p[this.name].push(this.value);
                } else {
                    p[this.name] = this.value;
                }
            });
            return p;
        }
        modalContent.on('click', '.btn-pro-code', function (e) {
            var _this = $(this);
            var code = modalContent.find('#pro_code');
            if (_this.attr('loading') == 1 || code.val().trim() == '') {
                return;
            }
            _this.attr('loading', 1);
            var data = formData();
            data['pro_code'] = code.val().trim();
            data['warehouse_id'] = $('[name=warehouse_id]').val();
            $.ajax({
                url: '/warehouse/product/',
                type: "POST",
                data: data,
                dataType: 'json',
                error: function () {
                    _this.attr('loading', 0);
                },
                success: function (resp) {
                    _this.attr('loading', 0);
                    if (resp.status != 'y') {
                        alert(resp.msg);
                        return;
                    }

                    var TID = [];
                    var row = resp.data;
                    if(Object.prototype.toString.call(row) !== '[object Object]'){
                        alert('商品不存在');
						return;
                    }

                    $.each(tableData(), function () {
                        TID.push(this.product_id);
                    });

                    if($.inArray(row.product_id, TID) != -1){
                        alert('已经存在列表中:' + row['product_name']);
                        return;
                    }

                    modalContent.find('table').bootstrapTable('prepend', row);
                    code.val('');
                    modalContent.find('table').find('[data-name=qty]').eq(0).trigger('click');
                }
            });
        }).on('keyup', '#pro_code', function (e) {
            var v = $(this).val().trim();
            if (v == '') {
                $('#pro_code_suggest').html('');
                return;
            }
            if (e.keyCode == 13) {
                $('.btn-pro-code').trigger('click');
            } else if (v.indexOf(',') == -1 && !(/^[U]?\d+$/.test(v))) {
                $.ajax({
                    url: '/warehouse/product_suggest/',
                    type: "POST",
                    data: {keyword: v},
                    dataType: 'json',
                    success: function (resp) {
                        var li = [];
                        if (resp && resp.status == 'y') {
                            $.each(resp.data, function () {
                                if (this.serial_number) {
                                    li.unshift('<li class="list-group-item" data-code="' + this.serial_number + '">' + this.product_name + ' <span class="badge">' + this.serial_number + '</span></li>');
                                } else {
                                    li.push('<li class="list-group-item disabled" data-code="">' + this.product_name + '</li>')
                                }

                            });
                        }
                        $('#pro_code_suggest').html(li.join(''));
                    }
                });
            }
        }).on('click', function (e) {
            $('#pro_code_suggest').html('');
        }).on('click', '#pro_code_suggest li', function (e) {
            var pro_code = $(this).data('code');
            if (!pro_code || pro_code == '') {
                $('#pro_code').val('');
                alert('请先绑定69码或唯一编码: ' + $(this).text());
                return;
            }
            $('#pro_code').val(pro_code);
            $('.btn-pro-code').trigger('click');

        }).on('click', '.btn-clear', function (e) {
            $(this).parent().prev().val('');
        }).on('click', '.btn-del', function (e) {
            var id = String($(this).parent().parent().data('uniqueid'));
            var row = modalContent.find('table').bootstrapTable('getRowByUniqueId', id);
            $.ajax({
                url: '/warehouse/product_label_check_editable/',
                type: "POST",
                data: {field: '', row: row, is_deleted: 1, old_value: '', warehouse_id: $('[name=warehouse_id]').val()},
                dataType: 'json',
                success: function (resp) {
                    if (resp.status != 'y') {
                        alert(resp.msg);
                        return;
                    }
                    modalContent.find('table').bootstrapTable('removeByUniqueId', id);
                }

            });


        });
    });
</script>