<style>
	.pagination-detail { padding-left: 10px }

	.pagination { padding-right: 10px }

	table {
		font-size: 12px;
	}
</style>
<div class="panel panel-default">
	<div class="panel-heading">
		<div class="pull-left toolbar">
			<button class="btn btn-info btn-sm btnModalMain">新增<{$keyObj.name}>标签</button>
		</div>
		<div class="pull-right form-inline searchbar">
			<div class="form-group">
				<select name="tag_id" id="tag_id" class="form-control">
					<option value="-1">-请选择标签-</option>
					<{foreach $tags as $k=>$v}>
					<option value="<{$v['id']}>"><{$v['name']}></option>
					<{/foreach}>
				</select>
			</div>
			<div class="form-group">
				<input type="text" class="form-control" name="name" placeholder="订单名称或订单号">
			</div>
			<div class="form-group">
				<button type="button" class="btn btn-default btn-search">查找</button>
			</div>
		</div>

		<div style="clear: both"></div>
	</div>
</div>
<table id="tagTableBody" class="table table-striped"></table>

<div class="modal fade" id="modalMain"></div>

<br/>
<br/>
<br/>
<nav class="navbar navbar-default navbar-fixed-bottom">
	<div class="form-inline">
		<div class="col-md-12 form-control-static tool-bottom text-center">
			批量:
			<select class="form-control makeTag">
				<option value="-1">-打标签-</option>
				<{foreach $tags as $k=>$v}>
				<option value="<{$v['id']}>"><{$v['name']}></option>
				<{/foreach}>
			</select>
			<select class="form-control unmakeTag">
				<option value="-1">-取消标签-</option>
				<{foreach $tags as $k=>$v}>
				<option value="<{$v['id']}>"><{$v['name']}></option>
				<{/foreach}>
			</select>
		</div>
	</div>
</nav>

<link href="/assets/bootstrap/css/bootstrap-editable.css" rel="stylesheet"/>
<script src="/assets/bootstrap/js/bootstrap-editable.min.js"></script>
<script src="/assets/bootstrap/js/bootstrap-table-editable.js" type='text/javascript'></script>
<script type="text/javascript">
    (function () {
        var key = '<{$key}>';
        var name = '<{$keyObj.name}>';
        var toolbar = $('.toolbar');
        var searchbar = $('.searchbar');
        var modalMain = $('#modalMain');
        var table = $('#tagTableBody');
        var toolBottom = $('.tool-bottom');


        var columns = [
            {checkbox: true},
            {field: 'product_id', title: '商品ID'},
            {field: 'product_name', title: '商品名称'},
            {field: 'pro_code', title: '编号'},
            {field: 'tag_name', title: '标签'}
        ];

        table.bootstrapTable({
            url: '/warehouse/order_tag_product_data/' + key,
            columns: columns,
            sidePagination: "server",
            queryParams: function queryParams(params) {
                searchbar.find('input, select').each(function () {
                    var _this = $(this), _val = $.trim(_this.val()), _tagName = _this.get(0).tagName;
                    if ((_tagName == 'INPUT' && _val != '') || (_tagName == 'SELECT' && _val != '-1')) {
                        var name = $(this).find("option:selected").data('name') || $(this).data('name') || $(this).attr('name');
                        params[name] = _val;
                    }

                });
                return params;
            },
            pagination: true,
            pageSize: 100,
            pageList: [50, 100, 150, 200]
        });


        toolbar.on('click', '.btnModalMain', function (e) {
            $.ajax({
                url: '/warehouse/order_tag_add/' + key,
                type: 'POST',
                success: function (resp) {
                    modalMain.html(resp);
                    modalMain.modal('show');
                }
            });
        });

        searchbar.on('click', '.btn-search', function () {
            table.bootstrapTable('refresh');
        });

        modalMain.on('hide.bs.modal', function (e) {
            table.bootstrapTable('refresh');
        });

        toolBottom.on('change', '.makeTag', function () {
            var _this = $(this);
            var data = {};
            data.tagID = $(this).val();
            data.proID = [];
            $.each(table.bootstrapTable('getSelections'), function () {
                data.proID.push(this.product_id);
            });
            if (data.tagID < 1 || data.proID.length < 1) {
                return;
            }

            if (!window.confirm('确认要批量 打标签 吗?')) {
                return;
            }

            $.ajax({
                url: '/warehouse/order_tag_make/' + key,
                type: 'POST',
                data: data,
                success: function (resp) {
                    _this.prop('selectedIndex', 0);
                    table.bootstrapTable('refresh');
                }
            });
        }).on('change', '.unmakeTag', function () {
            var _this = $(this);
            var data = {};
            data.tagID = $(this).val();
            data.proID = [];
            $.each(table.bootstrapTable('getSelections'), function () {
                data.proID.push(this.product_id);
            });
            if (data.tagID < 1 || data.proID.length < 1) {
                return;
            }

            if (!window.confirm('确认要批量 取消标签 吗?')) {
                return;
            }

            $.ajax({
                url: '/warehouse/order_tag_unmake/' + key,
                type: 'POST',
                data: data,
                success: function (resp) {
                    _this.prop('selectedIndex', 0);
                    table.bootstrapTable('refresh');
                }
            });
        });
    })();
</script>