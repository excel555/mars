<style type="text/css">
    .vertical-alignment-helper {
        display:table;
        height: 100%;
        width: 100%;

    }
    .vertical-align-center {
        text-align: center;
        /* To center vertically */
        display: table-cell;
        vertical-align: middle;
    }
</style>
<div class="panel panel-default">

    <div class="panel-heading">
        <span class="panel-title" style="width: 50%; color: #777;"> 商品情报 </span>
    </div>

    <div class="panel-body">
        <br>
        <div class="col-xs-6">

            <div class="col-xs-3">
                <img style="width: 100px;height: 100px" src="<{$img_http}><{$info['img_url']|default:'images/box_products_img/1760/1/1-180x180-1760-K7AW7HKP.jpg'}>">
            </div>
            <div class="col-xs-9">
                <h4><{$info['product_name']}>&nbsp;<{$info['volume']}></h4>
                <span>商品标签:</span><br/>
                <span>信息添加时间:<{$info['created_time']}></span><br/>
                <span>首次上架时间:<{$info['sale_time']}></span><br/>
                <span>时段复购率:<font class="product_avg">0</font>%</span>
            </div>
        </div>
        <div class="col-xs-6">
            <div class="col-sm-12" style="height: 50px"></div>
            <div class="col-sm-5" style="padding-right: 8px;">
                <div class="input-group date  col-md-12" data-link-field="dtp_input" id="time" >
                    <input class="form-control" type="text" name="start_date"  placeholder="开始时间"  readonly="readonly" value="<{$start_date}>">
                    <span class="input-group-addon"><span class="glyphicon glyphicon-remove"></span></span>
                    <span class="input-group-addon"><span class="glyphicon glyphicon-th"></span></span>
                </div>
            </div>
            <div class="col-sm-5" style="padding-right: 8px;">
                <div class="input-group date  col-md-12" data-link-field="dtp_input" id="time1" >
                    <input class="form-control" type="text" name="end_date"  placeholder="结束时间"  readonly="readonly" value="<{$end_date}>">
                    <span class="input-group-addon"><span class="glyphicon glyphicon-remove"></span></span>
                    <span class="input-group-addon"><span class="glyphicon glyphicon-th"></span></span>
                </div>
            </div>
            <div class="col-sm-2">
                <button type="button" class="btn btn-default" id="eq-search-btn">查找</button>
            </div>
        </div>
    </div>
    <br/>
    <br/>
    <br/>
    <div class="panel-body">
        <div id="main" style="width: 100%;height:300px;"></div>
    </div>
    <div class="panel-body">
        <div id="main2" style="width: 100%;height:300px;"></div>
    </div>
    <br/><br/>
    <div class="panel-body" style="width: 48%;float: left;">
        <div id="main3" style="width: 100%;height:270px;" ></div>
    </div>
    <div class="panel-body" style="width: 48%;float: left;">
        <div id="main4" style="width: 100%;height:250px;" ></div>
    </div>
    <div class="panel-body">
        <div id="main5" style="width: 100%;height: 200px"></div>
    </div>
    <div class="panel-body">
        <div id="main6" style="width: 100%;height:150px;"></div>
    </div>
</div>

<div class="panel panel-default">
    <div class="panel-heading">
        <span class="panel-title" style="width: 50%; color: #777;"> 库存模拟 </span>
    </div>
    <div id="main7" style="width: 100%;height:500px"></div>

    <!--<div class="store-box" style="min-height:250px;overflow-y:auto;max-height:500px;border-radius:5px;border:1px solid #ddd;padding:10px;">-->
    <!--</div>-->
</div>
<div class="modal " id="loadingModal" role="dialog" data-backdrop="static" data-keyboard="false">
    <div class="vertical-alignment-helper">
        <div class="modal-dialog vertical-align-center">
            <img src="/assets/images/loading.gif" width="20%" height="auto"  >
        </div>
    </div>
</div>
<script src="/assets/js/echarts.min.js"></script>
<script src="/assets/js/echarts-gl.min.js"></script>
<script type="application/javascript">
    var product_id = '<{$product_id}>';
    function show_loading(){
        $('#loadingModal').show().css('padding-right', '0px').append('<div class="modal-backdrop  in" style="height: 100%;"></div>');
    }

    function hide_loading(){
        $('#loadingModal').hide();//
        $('.modal-backdrop').remove();
    }

    function init_page(){
        show_loading();
        var start_date = $('input[name="start_date"]').val();
        var end_date   = $('input[name="end_date"]').val();

        $.ajax({
            url: '/report/product/ajax_data',
            data: {product_id: product_id, start_date: start_date, end_date:end_date},
            type: 'POST',
            dataType: 'json',
            success: function (data) {
                if(data['status'] == 'success'){
                    hide_loading();
                    chart_area(data['xAxis'], data['sale_money'], data['discount_money']);
                    chart_num(data['xAxis'], data['sale_num']);
                    chart_pie('main3', data['n_total'], data['n_t'], data['n_sale']);
                    chart_pie('main4', data['e_total'], data['e_t'], data['n_sale']);
                    chart_bar(data['relation_x'], data['relation_v'], false);
                    if(data['store_v'].length>12){
                        $('#main7').height(500);
                    }else{
                        $('#main7').height(data['store_v'].length*30 +100);
                    }
                    chart_store(data['store_x'],  data['store_v'], data['store_total']);
                    $('.product_avg').text(data['product_avg']);
                }
            }
        });


    }


    function chart_area(xAxis, sale_money, discount_money){
        var myChart = echarts.init(document.getElementById('main'));
        // 指定图表的配置项和数据
        var option = {
            tooltip : {
                trigger: 'axis',
                axisPointer: {
                    type: 'cross',
                    label: {
                        backgroundColor: '#6a7985'
                    }
                }
            },
            title: {
                subtext:'单品销售表现',
            },
            legend: {
                data:['单品销售额','单品补贴额']
            },

            xAxis: {
                type: 'category',
                axisLine: {
                    lineStyle: { color: '#666' }
                },
                boundaryGap: false,
                data: xAxis
            },
            yAxis: {
                type: 'value',
                axisLine: {
                    lineStyle: { color: '#666' }
                },
                boundaryGap: false,
                splitLine: { show: false }
            },
            series: [
                {
                    name: '单品销售额',
                    type: 'line',
                    smooth:true,
                    sampling: 'average',
                    itemStyle: {
                        normal: {
                            color: '#5BCCCB'
                        }
                    },
                    lineStyle:{
                        normal:{
                            width:1
                        }
                    },
                    areaStyle: {
                        normal: {
                            color: '#5BCCCB'
                        }
                    },
                    label: {
                        normal: {
                            show: true,
                            position: 'top'
                        }
                    },
                    data: sale_money
                },
                {
                    name: '单品补贴额',
                    type: 'line',
                    smooth:true,
                    sampling: 'average',
                    itemStyle: {
                        normal: {
                            color: '#C0E17B'
                        }
                    },
                    lineStyle:{
                        normal:{
                            width:1
                        }
                    },
                    areaStyle: {
                        normal: {
                            color:'#C0E17B'
                        }
                    },
                    data: discount_money
                }
            ]
        };
        myChart.setOption(option);
    }


    function chart_num(xAxis, sale_num){
        var myChart = echarts.init(document.getElementById('main2'));
        var option = {
            tooltip : {
                trigger: 'axis',
                axisPointer: {
                    type: 'cross',
                    label: {
                        backgroundColor: '#6a7985'
                    }
                }
            },
            title: {
                subtext:'销售数',
            },
            legend: {
                data:['销售数']
            },

            xAxis: {
                type: 'category',
                axisLine: {
                    lineStyle: { color: '#666' }
                },
                boundaryGap: false,
                data: xAxis
            },
            yAxis: {
                type: 'value',
                axisLine: {
                    lineStyle: { color: '#666' }
                },
                boundaryGap: false,
                splitLine: { show: false }
            },
            series: [
                {
                    name: '销售数',
                    type: 'line',
                    smooth:true,
                    sampling: 'average',
                    itemStyle: {
                        normal: {
                            color: '#C0E17B'
                        }
                    },
                    lineStyle:{
                        normal:{
                            width:1
                        }
                    },
                    areaStyle: {
                        normal: {
                            color: '#C0E17B'
                        }
                    },
                    label: {
                        normal: {
                            show: true,
                            position: 'top'
                        }
                    },
                    data: sale_num
                }
            ]
        };
        myChart.setOption(option);
    }


    function chart_pie(id, total_val, originalData, n_sale){
        var myChart = echarts.init(document.getElementById(id));
        // 总和
        var total = {
            name: '单品销售额',
            value: parseFloat(total_val)+'元('+n_sale+'件)'
        };

        option = {

            title: [{
                text: total.name,
                left: '49%',
                top: '40%',
                textAlign: 'center',
                textBaseline: 'middle',
                textStyle: {
                    color: '#999',
                    fontWeight: 'normal',
                    fontSize: 15
                }
            }, {
                text: total.value,
                left: '49%',
                top: '52%',
                textAlign: 'center',
                textBaseline: 'middle',
                textStyle: {
                    color: '#666',
                    fontWeight: 'normal',
                    fontSize: 12
                }
            }],
            series: [
                {
                    type:'pie',
                    radius: ['40%', '55%'],
                    label: {
                        normal: {
                            formatter: ' {b}：{c} 占比 {d}%  ',
                        }
                    },

                    data:originalData
                }
            ]
        };
        myChart.setOption(option, true);
    }


    function chart_bar(relation_x, relation_v){
        var myChart = echarts.init(document.getElementById('main5'));
        var appusage_data = relation_v;
        var option = {
            grid: {
                left: 180
            },
            "title": {
                "text": "关联购买商品",
                "textStyle": {
                    "color": "#bbb",
                    "fontWeight": "bold",
                    "fontSize": 14
                },
                "top": 10,
                "left": "43%"
            },
            "tooltip": {
                "trigger": "none"
            },
            "yAxis": [{
                "type": "category",
                "data": relation_x,
                "position": 'left',
                "nameLocation": 'start',
                "offset": 180,
                "axisLine": {
                    "show": false
                },
                "axisTick": {
                    "show": false,
                    "alignWithLabel": true
                },
                "axisLabel": {
                    "textStyle": {
                        "color": "#7FA98E",
                    },
                    inside: true
                }
            }],
            "xAxis": [{
                "type": "value",
                "axisLine": {
                    "show": false
                },
                "axisTick": {
                    "show": false
                },
                "axisLabel": {
                    "show": false
                },
                "splitLine": {
                    "show": false
                }
            }],

            "series": [{
                "type": "bar",
                "data": appusage_data,
                "barGap": 15,
                "barWidth":20,
                "label": {
                    "normal": {
                        "show": true,
                        "position": "right",
                        "formatter": function(params) {
                            return params.data.value;
                        },
                        "textStyle": {
                            "color": "#333" //color of value
                        }
                    }
                },
                "itemStyle": {
                    "normal": {
                        "color": '#7FA98E'
                    }
                }

            }]
        };
        myChart.setOption(option);

    }

    //库存模拟
    function chart_store(key, value, store_total){
        var myChart = echarts.init(document.getElementById('main7'));
        var appusage_data = value;
        var end_zoom = parseInt(100-12/value.length*100);
        var data_Zoom = value.length>12?[{
            show: true,
            height: 400,
            yAxisIndex: [0],
            bottom: 50,
            start: 100,
            end: end_zoom,
            handleIcon: 'path://M306.1,413c0,2.2-1.8,4-4,4h-59.8c-2.2,0-4-1.8-4-4V200.8c0-2.2,1.8-4,4-4h59.8c2.2,0,4,1.8,4,4V413z',
            handleSize: '110%',
            handleStyle:{color:"#d3dee5"},
            textStyle:{color:"#fff"},
            borderColor:"#90979c",
            orient:'vertical',
            zoomLock:true,
            filterMode:'empty',
            showDetail:false
        }]:[];


        var option = {
            "title": {
                "text": "设备数:"+value.length+"   设备在售件数:"+store_total,
                "textStyle": {
                    "color": "#bbb",
                    "fontWeight": "bold",
                    "fontSize": 14
                },
                "top": 10
            },
            tooltip: {
                "trigger": "axis",
                "axisPointer": {
                    "type": "shadow",
                    textStyle: {
                        color: "#fff"
                    }
                }
            },
            "grid": {
                left: 130
            },


            "calculable": true,
            "yAxis": [{
                "type": "category",
                "data": key,
                "position": 'left',
                "nameLocation": 'start',
                "offset": 130,
                "axisLine": {
                    "show": false
                },
                "axisTick": {
                    "show": false,
                    "alignWithLabel": true
                },
                "axisLabel": {
                    "textStyle": {
                        "color": "#7FA98E",
                    },
                    inside: true
                },
            }],
            "xAxis": [{
                "type": "value",
                "axisLine": {
                    "show": false
                },
                "axisTick": {
                    "show": false
                },
                "axisLabel": {
                    "show": false
                },
                "splitLine": {
                    "show": false
                }
            }],

            "dataZoom": data_Zoom,
            "series": [{
                "type": "bar",
                "data": appusage_data,
                "barGap": 10,
                "barWidth":20,
                "label": {
                    "normal": {
                        "show": true,
                        "position": "right",
                        "formatter": function(params) {
                            return params.data.value;
                        },
                        "textStyle": {
                            "color": "#333" //color of value
                        }
                    }
                },
                "itemStyle": {
                    "normal": {
                        "color": '#7FA98E'
                    }
                }
            }],
            toolbox: {
                show : true,
                feature : {
                    dataView : {
                        show: true,readOnly:true,
                        optionToContent: function(opt) {
                            var axisData = opt.series[0].data;
                            var table = '<table style="width:100%;text-align:left"><tbody><tr>'
                                    + '<td>设备名称</td>'
                                    + '<td>库存数量</td>'
                                    + '</tr>';
                            for (var i = axisData.length-1; i >=0; i--) {
                                table += '<tr>'
                                        + '<td>' + axisData[i]['name'] + '</td>'
                                        + '<td>' + axisData[i]['value'] + '</td>'
                                        + '</tr>';
                            }
                            table += '</tbody></table>';
                            return table;
                        }},
                }
            },
        };

        myChart.setOption(option);
        $('#main7').css('user-select', 'text');
    }


    $(document).ready(function(){
        $('#time').datetimepicker({
            language: 'zh', //汉化
            autoclose: 1,
            format: 'yyyy-mm-dd',
            minView: 'month'
        });
        $('#time1').datetimepicker({
            language: 'zh', //汉化
            autoclose: 1,
            format: 'yyyy-mm-dd',
            minView: 'month'
        });
        init_page();

        $('#eq-search-btn').click(function(){
            init_page();
        });
    });
</script>