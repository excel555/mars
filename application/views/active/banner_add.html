<div class="panel panel-default">
    <div class="panel-heading">
        <h3 class="panel-title">banner设置</h3>
    </div>
    <div class="panel-body">
        <form method="post"  enctype="multipart/form-data" class="form-horizontal"  action="/active/banner_save" onsubmit="return submit_model(this);" data-url="/active/banner" >
            <div class="form-group">
                <label  class="col-sm-2 control-label">补货仓：</label>
                <div class="col-sm-10">
                    <{foreach key=key item=item from=$store_list}>
                    <label style="margin-right:10px;font-weight: normal">
                        <input onclick="get_box_list(this)" type="checkbox" name="store_id[]" data-store-type="<{$item['code']}>" value="<{$item['code']}>"> <{$item['name']}>
                    </label>
                    <{/foreach}>
                </div>
            </div>
			<div class="form-group">
                <label  class="col-sm-2 control-label">导入设备id(#号分割)：</label>
                <div class="col-sm-10">
                    <textarea rows="5" cols="130" id="eq_box_id"></textarea>
                </div>
            </div>
            <div class="form-group">
                <label  class="col-sm-2 control-label">banner显示设备ID：
                    <br><br><br><br>
                    <input type="checkbox" value="" id="box_check_all"> 全选

                </label>
                <div class="col-sm-10">
                    <div class="store-box" style="min-height:150px;overflow-y:auto;max-height:200px;border-radius:5px;border:1px solid #aaa;padding:10px;">
                        <{foreach key=key item=item from=$equipment_list}>
                        <label style="margin-right:10px;font-weight: normal">
                            <input type="checkbox" <{if $item['checked'] eq 1}>checked="true"<{/if}> name="box_no[]" data-store-type="<{$item['replenish_warehouse']}>" value="<{$item['equipment_id']}>"> <{$item['name']}>
                        </label>
                        <{/foreach}>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-2 control-label">banner类型：</label>
                <div class="col-sm-5">
                    <select class="form-control" name="type">
                        <option value="1" <{if $detail['type'] eq '1'}>selected="true"<{/if}>>普通banner</option>
                        <option value="2" <{if $detail['type'] eq '2'}>selected="true"<{/if}>>弹出banner</option>
                        <option value="3" <{if $detail['type'] eq '3'}>selected="true"<{/if}>>结算页banner</option>
                    </select>
                </div>
            </div>
			<div class="form-group">
                <label class="col-sm-2 control-label">目标用户：</label>
                <div class="col-sm-5">
                    <select class="form-control" name="active_people">
                        <option value="0" <{if $detail['active_people'] eq '0'}>selected="true"<{/if}>>全体用户</option>
                        <option value="1" <{if $detail['active_people'] eq '1'}>selected="true"<{/if}>>仅新用户</option>
                        <option value="2" <{if $detail['active_people'] eq '2'}>selected="true"<{/if}>>白名单用户</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-2 control-label">用户来源：</label>
                <div class="col-sm-5">
                    <select class="form-control" name="refer">
                        <option value="all" <{if $detail['refer'] eq 'all'}>selected="true"<{/if}> >所有来源</option>
                        <option value="alipay" <{if $detail['refer'] eq 'alipay'}>selected="true"<{/if}> >支付宝</option>
                        <option value="wechat" <{if $detail['refer'] eq 'wechat'}>selected="true"<{/if}> >微信</option>
                        <option value="fruitday" <{if $detail['refer'] eq 'fruitday'}>selected="true"<{/if}> >天天果园</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group white_mobile <{if $detail['active_people'] neq '2'}>hide<{/if}>">
                <label class="col-sm-2 control-label">白名单：<br><span style="color: #aaa;font-size: 10px">填手机,多个#号分割</span></label>
                <div class="col-sm-10">
                    <textarea rows="5" class="form-control" name="white_mobile" placeholder="白名单(填手机,多个#号分割)"><{$white_mobile['mobile']|default:''}></textarea>
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-2 control-label">开始时间：</label>
                <div class="col-sm-5">
                    <div class="input-group date  col-md-10" data-link-field="dtp_input1" id="time" >
                        <input class="form-control" type="text" name="start_time" value="<{$detail['start_time']}>" placeholder="开始时间"  readonly>
                            <span class="input-group-addon"><span class="glyphicon glyphicon-remove"></span></span>
                    <span class="input-group-addon"><span class="glyphicon glyphicon-th"></span></span>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-2 control-label">截止时间：</label>
                <div class="col-sm-5">
                    <div class="input-group date  col-md-10" data-link-field="dtp_input2" id="to_date" >
                        <input class="form-control" type="text" name="end_time" value="<{$detail['end_time']}>" placeholder="结束时间"  readonly>
                        <span class="input-group-addon"><span class="glyphicon glyphicon-remove"></span></span>
                        <span class="input-group-addon"><span class="glyphicon glyphicon-th"></span></span>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label class="col-sm-2 control-label">banner图：</label>
                <div class="col-sm-5">
                    <input type="file" name="img_banner_file" id="img_banner_file" class="pull-left" data-attr="banner图不能为空" onchange="ajaxFileUpload(this.id);">
                    <input type="hidden" name="img_banner" value="<{$detail['img_banner']}>">
                    <a class="show_img <{if $detail['img_banner'] eq ''}>hide<{/if}>" href="javascript:void(0)" data-content="<img src='<{$img_http}><{$detail['img_banner']}>' width='200px'>" data-original-title="" title="">查看</a>
                </div>
                <label class="control-label" style="color:#aaa;font-size: 12px">普通建议尺寸(1080 x 450)，弹出建议尺寸(845 x 1185)，结算页建议尺寸(1125 x 420)</label>
            </div>
            
            <div class="form-group">
                <label class="col-sm-2 control-label">点击类型：</label>
                <div class="col-sm-5">
                    <select class="form-control" name="click_type" id="click_type">
                        <option value="0" <{if $detail['click_type'] eq '0'}>selected="true"<{/if}>>无动作</option>
                        <option value="1" <{if $detail['click_type'] eq '1'}>selected="true"<{/if}>>跳转url</option>
                        <option value="2" <{if $detail['click_type'] eq '2'}>selected="true"<{/if}>>弹出图片</option>
                    </select>
                </div>
            </div>
            
            <div id="click_div" class="form-group <{if $detail['click_type'] eq '0' || !$detail}>hide<{/if}>">
                <label class="col-sm-2 control-label" id="click_str"><{if $detail['click_type'] eq '1'}>跳转url：<{/if}><{if $detail['click_type'] eq '2'}>弹出图片：<{/if}></label>
                <div id="div_redirect_url" class="col-sm-5 <{if $detail['click_type'] neq '1'}>hide<{/if}>">
                	<input type="text" class="form-control" name="redirect_url" placeholder="跳转链接" value="<{$detail['click_url']}>">
                </div>
                <div id="div_pop_img" class="col-sm-5 <{if $detail['click_type'] neq '2'}>hide<{/if}>">
                    <input type="file" name="img_click_file" id="img_click_file" class="pull-left" data-attr="弹出图片不能为空" onchange="ajaxFileUpload(this.id);">
                    <input type="hidden" name="img_click" value="<{$detail['click_url']}>">
                    <a class="show_img <{if $detail['click_url'] eq ''}>hide<{/if}>" href="javascript:void(0)" data-content="<img src='<{$img_http}><{$detail['click_url']}>' width='200px'>" data-original-title="" title="">查看</a>
                </div>
            </div>
            
            <div class="form-group">
                <label class="col-sm-2 control-label">banner备注：</label>
                <div class="col-sm-5">
                    <input type="text" class="form-control" name="remarks" placeholder="banner备注" value="<{$detail['remarks']}>">
                </div>
                
            </div>
            
            <div class="form-group">
                <label class="col-sm-2 control-label">会员等级：</label>
                <div class="col-sm-10">
                    <div class="checkbox">
                        <{foreach key=key item=item from=$user_rank}>
                        <label>
                            <input type="checkbox" name="user_rank" value="<{$item['key']}>" <{if $item['checked'] eq 1}>checked="checked"<{/if}> >  <{$item['name']}>
                        </label>
                        <{/foreach}>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label  class="col-sm-2 control-label">管理员：</label>
                <div class="col-sm-5">
                    <input type="text" class="form-control" name="admin_name" readonly="readonly" value="<{$adminname}>">
                </div>
            </div>
            <div class="form-group">
                <div class="col-sm-offset-2 col-sm-10">
                    <input type="hidden" class="form-control" name="id" value="<{$detail['id']|default:0}>">
                    <input class="btn btn-primary" type="submit" value="提交">
                </div>
            </div>
        </form>
    </div>
</div>
<script type="application/javascript" src="/assets/js/ajaxfileupload.js"></script>
<script>
    $(function(){
        $('#time').datetimepicker({
            language: 'zh', //汉化
            autoclose: 1,
            format:'yyyy-mm-dd hh:ii:00',      //格式化日期
            timepicker:false    //关闭时间选项
        });
        $('#to_date').datetimepicker({
            language: 'zh', //汉化
            autoclose: 1,
            format: 'yyyy-mm-dd hh:ii:00',
            timepicker:false    //关闭时间选项
        });
        $('#box_check_all').click(function(){
            var flag = $(this).prop('checked');
            $('.store-box').find('input[type="checkbox"]').prop('checked', flag)
        });
        $(".show_img").popover({
            placement: 'right',
            trigger: 'hover',
            html: true
        });
        
        $("select[name='active_people']").change(function(){
            if($(this).val() == 2){
                $('.white_mobile').removeClass('hide');
            }else{
                $('textarea[name="white_mobile"]').val('');
                $('.white_mobile').addClass('hide');
            }
        })
        
        $('#eq_box_id').change(function(){
            var arr = $(this).val().split('#');
            $('.store-box').find('input').each(function(i,v){
                var _this_val = $(this).val();
                if($.inArray(_this_val, arr)>-1){
                    $(this).prop('checked', true);
                }else{
                    $(this).prop('checked', false);
                }
            });
        });
        
        $("#click_type").change(function(){
            if($(this).val() == 2 || $(this).val() == 1){
                $('#click_div').removeClass('hide');
                if ($(this).val() == 1){
                	$('#click_str').html('跳转url：');
                	$('#div_redirect_url').removeClass('hide');
                	$('#div_pop_img').addClass('hide');
                } else {
                	$('#click_str').html('弹出图片：');
                	$('#div_redirect_url').addClass('hide');
                	$('#div_pop_img').removeClass('hide');
                }
            }else{
                $('#click_div').addClass('hide');
            }
        })
    });

    function submit_model(obj){
        var _url = $(obj).attr('data-url');
        ajaxSubmit(obj, function(data){
            $(obj).attr('lock', 0);
            if(data.status=='success'){
                alert('成功');
                location.href=_url;
            }else{
                alert(data.msg);
                return false;
            }
        });
        return false;
    }
    //将form转为AJAX提交
    function ajaxSubmit(frm, fn) {
        var dataPara = getFormJson(frm);
        $.ajax({
            url: frm.action,
            type: frm.method,
            data: dataPara,
            dataType:'json',
            success: fn
        });
    }

    //将form中的值转换为键值对。
    function getFormJson(frm) {
        var o = {};
        var a = $(frm).serializeArray();
        $.each(a, function () {
            if (o[this.name] !== undefined) {
                if (!o[this.name].push) {
                    o[this.name] = [o[this.name]];
                }
                o[this.name].push(this.value || '');
            } else {
                o[this.name] = this.value || '';
            }
        });
        return o;
    }

    function get_box_list(obj){
        var code = $(obj).attr('data-store-type');
        var flag = $(obj).prop('checked');
        $('.store-box').find('input[data-store-type="'+code+'"]').prop('checked', flag)
    }
    function get_class_list(obj){
        var flag = $(obj).prop('checked');
        $('.class-box').find('input[type="checkbox"]').prop('checked', flag)
    }
    function ruleAdd(obj){
        var html = $(obj).parent().parent().clone();
        $(obj).parent().parent().parent().append(html);
    }
    function ruleDel(obj){
        if($(obj).parent().parent().siblings().length<=1){
            return false;
        }
        $(obj).parent().parent().remove();
    }
    
    //ajax上传图片
    function ajaxFileUpload(elementId) {
        $.ajaxFileUpload({
            url: '/active/ajax_upload_img', //用于文件上传的服务器端请求地址
            secureuri: false, //是否需要安全协议，一般设置为false
            fileElementId: elementId, //文件上传域的ID
            dataType: 'json', //返回值类型 一般设置为json
            success: function (data, status)  //服务器成功响应处理函数
            {
                if(data.status=='error'){
                    alert(data.msg);
                    return false;
                }
                if (typeof (data.status) != 'undefined') {
                    $("#"+elementId).next().val(data.url);
                    var html = "<img src='"+data.img_http+data.url+"' width='200px'>";
                    $("#"+elementId).next().next().removeClass('hide').attr('data-content', html);

                }
            },
            error: function (data, status, e)//服务器响应失败处理函数
            {
                alert(e);
            }
        });
        return false;
    }
</script>