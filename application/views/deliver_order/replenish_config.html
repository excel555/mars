<style type="text/css">
	.pagination-detail { padding-left: 10px }

	.pagination { padding-right: 10px }

	table, .panel {
		font-size: 12px;
	}

	table img {
		border-radius: 5px;
	}

	.panel .btn-warning .badge {
		color: #f0ad4e;
		background-color: #fff;
	}

	.panel .btn-danger .badge {
		color: #d9534f;
		background-color: #fff;
	}

	.list-group{ margin-bottom: 0}
	#pro_code_suggest { font-size: 12px }
	#pro_code_suggest .badge{ background-color: #f0ad4e; }

</style>
<div class="panel panel-default">
	<div class="panel-heading">
		<div class="pull-left toolbar">
			<span class="btn btn-sm btn-success btn-add">新增自动补货商品配置</span><span style="color:red"> 注: 仅限自动补货设备</span>
		</div>
		<div class="pull-right form-inline searchbar">
			<div class="form-group form-group-sm">
				<select name="status" id="status" class="form-control">
					<option value="-1">-状态-</option>
					<option data-name="valid_date" value="1">有效</option>
					<option data-name="valid_date" value="0">无效</option>
					<option data-name="is_valid" value="1">启用</option>
					<option data-name="is_valid" value="0">未启用</option>
				</select>
			</div>
			<div class="form-group form-group-sm">
				<input type="text" class="form-control" name="name" placeholder="商品名称">
			</div>
			<div class="form-group form-group-sm">
				<button type="button" class="btn btn-sm btn-default btn-search">查找</button>
			</div>
		</div>

		<div style="clear: both"></div>
	</div>
</div>
<table id="tableBody" class="table table-striped"></table>
<div class="modal fade">
	<div class="modal-dialog">
		<div class="modal-content"></div>
	</div>
</div>
<link href="/assets/bootstrap/css/bootstrap-editable.css" rel="stylesheet"/>
<script src="/assets/bootstrap/js/bootstrap-editable.min.js"></script>
<script src="/assets/bootstrap/js/bootstrap-table-editable.js" type='text/javascript'></script>

<script type="text/javascript">
    $(function () {
        var columns = [
            {field: 'product_id', title: '商品ID', width: 60},
            {field: 'product_name', title: '商品名称'},
            {field: 'name', title: '备注', width: 150},
            {field: 'qty', title: '数量', width: 40},
            {field: 'start_date', title: '开始时间', width: 80},
            {field: 'end_date', title: '结束时间', width: 80},
            {field: 'type_str', title: '类型', width: 120},
            {field: 'eq_type_str', title: '设备类型', width: 100},
            {field: 'is_valid', title: '是否启用', width: 100, formatter: function (value,row) {
		            return value > 0 ? '<span class="text-success">启用</span>' : '<span class="text-danger">未启用</span>';
             }},
           {
               field: 'operation', title: '操作', align: 'center', width: 120,
               formatter: function (value, row, index) {
                   var btn = ['<span class="btn btn-xs btn-info btn-edit">编辑</span>'];
                   if(row.is_valid > 0){
                       btn.push('<span class="btn btn-xs btn-danger btn-valid" data-value="0">禁用</span>');
                   }else{
                       btn.push('<span class="btn btn-xs btn-success btn-valid" data-value="1">启用</span>');
                   }
                   return btn.join(' ');
               }
           }
        ];
        var table = $('#tableBody'),
            modal = $('.modal'),
            modalContent = $('.modal-content'),
            btnAdd = $('.btn-add');


        table.bootstrapTable({
            url: '/deliver_order/replenish_config_data/',
            uniqueId: 'id',
            columns: columns,
            sidePagination: "server",
            queryParams: function queryParams(params) {
                $('.searchbar').find('input, select').each(function () {
                    var _this = $(this), _val = $.trim(_this.val()), _tagName = _this.get(0).tagName;
                    if ((_tagName == 'INPUT' && _val != '') || (_tagName == 'SELECT' && _val != '-1')) {
                        var name = $(this).find("option:selected").data('name') || $(this).data('name') || $(this).attr('name');
                        params[name] = _val;
                    }

                });
                return params;
            },
            onEditableShown: function (field, row, $el, editable) {
                if(editable.input.$clear){
                    editable.input.$clear.trigger('click');
                }

            },
            onEditableSave: function (field, row, oldValue, $el) {
                $.ajax({
                    url: '/deliver_order/replenish_config_editable/',
                    type: "POST",
                    data: {field: field, row: row, old_value: oldValue},
                    dataType: 'json',
                    success: function (resp) {
                        var set = row;
                        if (resp.status != 'y') {
                            set[field] = oldValue;
                        }
                        table.bootstrapTable('updateByUniqueId', set);
                    }
                });
            },
            onLoadSuccess: function (data) {
                console.log(data);
            },
            pagination: true,
            pageSize: 10,
            pageList: [10, 25, 50, 100]
        });

        $('.btn-search').on('click', function () {
            table.bootstrapTable('refresh');
        });

        var eidValues = false;
        btnAdd.on('click', function () {
            modalContent.html('');
            eidValues = false;
            $.ajax({
                url: '/deliver_order/replenish_config_add',
                dataType: 'html',
                success: function (resp) {
                    modalContent.html(resp);
                    modal.modal('show');
                    eidValues = {};
                    $('#eids input').each(function () {
                        eidValues[$(this).val()] = true;
                    });
                    modalContent.find('.start_date,.end_date').datetimepicker({
                        language: 'zh', //汉化
                        autoclose: 1,
                        format: 'yyyy-mm-dd',
                        minView: 2
                    });
                }

            });
        });

        modalContent.on('click', '.btn-add-save', function () {
            var _this = $(this);
            if (_this.data('loading') == 1) {
                return;
            }
            _this.data('loading', 1);
	        var eids = [];
            $('#eids input').each(function(){
                if($(this).prop('checked')){
                    eids.push($(this).val());
                }
            });


            var data = modalContent.find('form').serialize() + '&eids=' + eids;

            $.ajax({
                url: '/deliver_order/replenish_config_add_save',
                type: 'post',
                dataType: 'json',
                data: data,
                success: function (resp) {
                    _this.data('loading', 0);
                    if (resp.status == 'n') {
                        alert(resp.msg);
                    } else {
                        modal.modal('hide');
                        table.bootstrapTable('refresh');
                    }
                }

            });

        }).on('keyup', '#pro_code', function (e) {
            var v = $(this).val().trim();
            if (v == '') {
                $('#pro_code_suggest').html('');
                return;
            }
            $.ajax({
                url: '/warehouse/product_suggest/',
                type: "POST",
                data: {keyword: v},
                dataType: 'json',
                success: function (resp) {
                    var li = [];
                    if (resp && resp.status == 'y') {
                        $.each(resp.data, function () {
                            li.unshift('<li class="list-group-item" data-code="' + this.product_id + '">' + this.product_name + ' <span class="badge">' + this.product_id + '</span></li>');

                        });
                    }
                    $('#pro_code_suggest').html(li.join(''));
                }
            });
        }).on('click', function (e) {
            $('#pro_code_suggest').html('');
        }).on('click', '#pro_code_suggest li', function (e) {
            var pro_code = $(this).data('code');
            $('#pro_code').val(pro_code);
            $('.btn-pro-code').trigger('click');

        }).on('click', '.eq_type input', function(){
            var ind = modalContent.find('.eq_type input').index($(this));
            $('.eq_value').addClass('hide');
            $('.eq_value').eq(ind).removeClass('hide');
        }).on('click', '#eids .btn-select-all', function(){
            var checked = $('#eids input:checked');
            if(checked.length > 0){
                checked.prop('checked', false);
            }else{
                $('#eids input').prop('checked', true);
            }
        }).on('blur', '#eids textarea', function(){
            var v = $(this).val().trim().replace('#', ',');
            if(!v || v == ""){
                return;
            }
            v = v.split(',');
            for(var i in v){
                var eid = v[i].trim();
                if(eidValues[eid]){
                    $('#eids input[value='+eid+']').prop('checked', true);
                }
            }
        });

        table.on('click', '.btn-edit', function () {
            var _this = $(this), uniqueid = _this.parent().parent().data('uniqueid');

            modalContent.html('');
            eidValues = false;
            $.ajax({
                url: '/deliver_order/replenish_config_edit/' + uniqueid,
                dataType: 'html',
                success: function (resp) {
                    modalContent.html(resp);
                    modal.modal('show');
                    eidValues = {};
                    $('#eids input').each(function () {
                        eidValues[$(this).val()] = true;
                    });
                    modalContent.find('.start_date,.end_date').datetimepicker({
                        language: 'zh', //汉化
                        autoclose: 1,
                        format: 'yyyy-mm-dd',
                        minView: 2
                    });
                }

            });

        }).on('click', '.btn-valid', function (e) {
            var _this = $(this), uniqueid = _this.parent().parent().data('uniqueid');
            var row = $(e.delegateTarget).bootstrapTable('getRowByUniqueId', uniqueid);
            var oldValue = row.is_valid;
            row.is_valid = _this.data('value');
            if(_this.data('loading') == 1){
                return;
            }
            _this.data('loading', 1);
            $.ajax({
                url: '/deliver_order/replenish_config_editable/',
                type: "POST",
                data: {field: 'is_valid', row: row, old_value: oldValue},
                dataType: 'json',
                success: function (resp) {
                    if (resp.status == 'y') {
                        table.bootstrapTable('updateByUniqueId', row);
                        return;
                    }
                    _this.data('loading', 0);
                }
            });
        });
    });
</script>