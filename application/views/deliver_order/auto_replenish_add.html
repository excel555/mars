<style>
	#pro_code_suggest { font-size: 12px }

	#pro_code_suggest .badge { background-color: #f0ad4e; }


	.pagination-detail { padding-left: 10px }

	.pagination { padding-right: 10px }

	table,.panel {
		/*font-size: 12px;*/
	}
	table img{
		border-radius: 5px;
	}

	.panel .btn-warning .badge{
		color: #f0ad4e;
		background-color: #fff;
	}
	.panel .btn-danger .badge{
		color: #d9534f;
		background-color: #fff;
	}
	.list-group{
		margin-bottom: 0;
	}
	.popover{max-width: 420px;}
	.panel-heading .form-group{ margin-bottom: 0;}
	/*.panel-heading .control-label{ padding-top: 0 !important;}*/
	.editable-input input{width: 100% !important;}
	.editable-input input{width: 100% !important;}
	.editable-click{display: inline-block; margin-bottom: 9px}

</style>
<div class="panel panel-default">
	<div class="panel-heading">
		<form class="form-horizontal from-body">
			<div class="form-group form-group-sm">
				<div class="col-sm-4">
					<div class="input-group">
						<input type="text" class="form-control" autocomplete="off" id="pro_code" placeholder="商品ID">
						<span class="input-group-btn">
                            <button class="btn btn-default btn-sm btn-clear" type="button"><i class="glyphicon glyphicon-remove"></i></button>
                            <button class="btn btn-success btn-sm btn-pro-code" type="button"><i class="glyphicon glyphicon-plus"></i></button>
                        </span>
					</div>
					<ul class="list-group" id="pro_code_suggest"></ul>
				</div>
				<div class="col-sm-4">
					<label class="control-label">补货日期:</label>
					<select style="display:inline-block; width: auto" id="send_date" class="form-control" name="send_date">
						<{foreach key=key item=val from=$datetime_options}>
						<option <{if $key eq 1}>selected=selected<{/if}> value="<{$val}>"><{$val}></option>
						<{/foreach}>
					</select>
					<label class="control-label">补货批次:</label>
					<select style="display:inline-block; width: auto" id="send_batch" class="form-control" name="send_batch">
						<{foreach key=key item=val from=$send_batch_options}>
						<option <{if $key eq 1}>selected=selected<{/if}> value="<{$key}>"><{$val}></option>
						<{/foreach}>
					</select>
				</div>
				<div class="col-sm-4" style="font-size: 12px; line-height: 35px; text-align: right">
					<{$day}>日出库单:
					<{foreach item=order from=$shipping_order}>
					<a target="_blank" href="/deliver/shipping_view_order_products/<{$order.id}>"><{$order.shipping_no}></a>(<span style="color: red"><{$so_name[$order.operation_id]}></span>)
					<{foreachelse}>
					<span style="color: red">无出库单</span>
					<{/foreach}>
				</div>
			</div>
		</form>
	</div>
</div>
<table id="tableData" class="table table-striped"></table>
<br/>
<br/>
<br/>
<nav class="navbar navbar-default navbar-fixed-bottom">
	<div class="form-inline">
		<div class="col-md-12 form-control-static tool-bottom text-center">
			<label class="control-label" style="font-size: 20px; margin-right: 20px"><{$equipment['name']}><{if $equipment['is_auto'] == 1}><span style="font-size: 12px; color: red">(自动)</span><{/if}></label>
			补货量合计: <span class="label label-danger" id="add_qty">0</span>
			盒子在售库存: <span class="label label-danger" id="box_stock">0</span>
			补货后库存: <span class="label label-danger" id="total_stock">0</span>
			<span style="display: inline-block; margin-left: 30px" class="btn btn-success btn-save" data-max-qty="<{$equipment['max_qty']}>" data-is-auto="<{$equipment['is_auto']}>">提交补货单</span> <span style="color: red" id="save-help"></span>
		</div>
	</div>
</nav>

<link href="/assets/bootstrap/css/bootstrap-editable.css" rel="stylesheet"/>
<link href="/assets/bootstrap/css/bootstrap-table-sticky-header.css" rel="stylesheet"/>
<script src="/assets/bootstrap/js/bootstrap-editable.min.js"></script>
<script src="/assets/bootstrap/js/bootstrap-table-editable.js" type='text/javascript'></script>
<script src="/assets/bootstrap/js/bootstrap-table-sticky-header.js" type='text/javascript'></script>
<script type="text/javascript">
    (function () {
        var table = $('#tableData');
        var code = $('#pro_code');
        var toolBottom = $('.tool-bottom');
        var form = $('.from-body');
        var equipment_id = <{$equipment['id']}>;
        var total_box_stock = 0;
        var columns = [
            {field: 'product_id', title: '商品ID'},
            {field: 'product_name', title: '商品名称'},
            {field: 'parent_class_name', title: '一级类目', sortable: true},
            {field: 'class_name', title: '二级类目', sortable: true},
            {field: 'price', title: '价格', width: '80'},
            {field: 'today_qty', title: '今日补量', width: '80'},
            {field: 'wh_stock', title: '可用库存',  width: '80',
                formatter: function (value, row, index) {
                    var v = typeof value === 'object' ? value.stock_usable : 0;
                    return v > 0 ? v : '<span style="color: red">0</span>';
                }
            },
            {field: 'wh_stock', title: '冻结库存',  width: '80',
                formatter: function (value, row, index) {
                    var stock = typeof value === 'object' ? value.stock_lock : 0;
                    if(stock > 0){
	                    return '<span data-lock-purchase="'+value.stock_lock_purchase+'" class="btn btn-info btn-xs btn-stock-lock" data-toggle="popover">'+stock+'</span>';
                    }else{
                        return 0;
                    }
                }
            },
            {field: 'pre_qty', title: '预存量',  width: '80',
                formatter: function (value, row, index) {
                    return value > 0 ? value : 0;
                }
            },
            {field: 'stock', title: '在售库存',  width: '80'},
            {
                field: 'add_qty', title: '补货量',  width: '100', sortable: true,
                editable: {
                    type: 'text',
                    showbuttons: false,
                    mode: 'inline',
                    onblur: 'submit',
                    defaultValue: 0,
                    validate: function (v) {
                        if (v !== '' && !/^\d+$/.test(v)) {
                            return '格式错误, 只能为正整数';
                        }
                    }
                },
                formatter: function (value, row, index) {
                    row['add_qty'] = row['add_qty'] ? row['add_qty'] : 0;
                    return value > 0 ? value : 0;
                }
            },
            {
                field: 'operation', title: '操作', align: 'center', width: '70',
                formatter: function (value, row, index) {
                    return ['<a data-pid="' + row.product_id + '" class="btn btn-xs btn-danger btn-del"><i class="glyphicon glyphicon-remove"></i></a>'].join('');
                }
            }
        ];

        function tableData() {
            return table.bootstrapTable('getData');
        }

        function checkRow(rows, id) {
            var ins = [];
            var existed = [];
            var TID = [];
            $.each(tableData(), function () {
                TID.push(this.product_id);
            });

            $.each(rows, function () {
                if ($.inArray(this.product_id, TID) < 0) {
                    ins.push(this);
                } else {
                    existed.push(this[id]);
                }
            });

            return {ins: ins, existed: existed};
        }

        function formData() {
            var p = {};
            $.each(form.serializeArray(), function () {
                if (this.name.indexOf('[]') > -1) {
                    if (p[this.name] === undefined) {
                        p[this.name] = [];
                    }
                    p[this.name].push(this.value);
                } else {
                    p[this.name] = this.value;
                }
            });
            return p;
        }
        function tableStat(){
            var data = tableData();
            var add_qty = 0;
            data = Object.prototype.toString.call(data) === '[object Array]' ? data : [];
            $.each(data, function () {
                add_qty += parseInt(this.add_qty);
            });

            $('#add_qty').text(add_qty);
            $("#box_stock").text(total_box_stock);
            $('#total_stock').text(add_qty + total_box_stock);

            var limit_max_qty = $('[data-max-qty]');
            if(limit_max_qty.length > 0 && limit_max_qty.data('maxQty') > 0){
                if(limit_max_qty.data('maxQty') < add_qty + total_box_stock){
                    limit_max_qty.addClass('disabled btn-default');
                    limit_max_qty.removeClass('btn-success');
                    $('#save-help').text('超:' + (add_qty + total_box_stock - parseInt(limit_max_qty.data('maxQty'))));
                }else{
                    limit_max_qty.removeClass('disabled btn-default');
                    limit_max_qty.addClass('btn-success');
                    $('#save-help').text('');
                }
            }
        }

        $.ajax({
            url: '/deliver_order/auto_replenish/',
            type: "POST",
            data: {eid: equipment_id || 0},
            dataType: 'json',
            success: function (resp) {
                if(resp && resp.status == 'n'){
                    alert(resp.msg);
                    window.location.href = '/deliver/shipping';
                    return;
                }

                if(!resp || !resp.rows || resp.rows.length == 0){
                    return;
                }

                total_box_stock = parseInt(resp.box_stock || 0);
                table.bootstrapTable('load', resp.rows);
            }
        });

        table.bootstrapTable({
            columns: columns,
            uniqueId: 'product_id',
            silentSort: false,
            stickyHeader: true,
            stickyHeaderOffsetY: '50px',
            onPostBody: function (data) {
                tableStat();
            },
            onEditableShown: function (field, row, $el, editable) {

                if(!row[field]){
                    editable.input.$clear.trigger('click');
                }

            },
            onEditableSave: function (field, row, oldValue, $el) {
                 tableStat();
            }
        });

        form.on('click', '.btn-pro-code', function (e) {
            var _this = $(this);
            if (_this.attr('loading') == 1 || code.val().trim() == '') {
                return;
            }
            _this.attr('loading', 1);
            var data = formData();
            data['product_id'] = code.val().trim();
            data['equipment_id'] = equipment_id || 0;
            $.ajax({
                url: '/deliver_order/product_info',
                type: "POST",
                data: data,
                dataType: 'json',
                error: function () {
                    _this.attr('loading', 0);
                },
                success: function (resp) {
                    _this.attr('loading', 0);
                    if (resp.status != 'y') {
                        alert(resp.msg);
                        return;
                    }

                    var cr = checkRow([resp.data], 'product_id');
                    console.log(cr);
                    table.bootstrapTable('prepend', cr.ins);
                    if (cr.existed.length > 0) {
                        alert(resp.data.product_name + ': 已经存在列表中');
                        return;
                    }

                    if (cr.ins.length > 0) {
                        code.val('');
                        table.find('[data-name=add_qty]').eq(0).trigger('click');
                    }
                }
            });
        }).on('keyup', '#pro_code', function (e) {
            var v = $(this).val().trim();
            if (v == '') {
                $('#pro_code_suggest').html('');
                return;
            }
            if (e.keyCode == 13) {
                $('.btn-pro-code').trigger('click');
            } else if (v.indexOf(',') == -1 && !(/^[U]?\d+$/.test(v))) {
                $.ajax({
                    url: '/warehouse/product_suggest/',
                    type: "POST",
                    data: {keyword: v},
                    dataType: 'json',
                    success: function (resp) {
                        var li = [];
                        if (resp && resp.status == 'y') {
                            $.each(resp.data, function () {
                                if (this.product_id) {
                                    li.unshift('<li class="list-group-item" data-code="' + this.product_id + '">' + this.product_name + ' <span class="badge">' + this.product_id + '</span></li>');
                                } else {
                                    li.push('<li class="list-group-item disabled" data-code="">' + this.product_name + '</li>')
                                }

                            });
                        }
                        $('#pro_code_suggest').html(li.join(''));
                    }
                });
            }
        }).on('click', function (e) {
            $('#pro_code_suggest').html('');
        }).on('click', '#pro_code_suggest li', function (e) {
            var pro_code = $(this).data('code');
            if (!pro_code || pro_code == '') {
                $('#pro_code').val('');
                alert('请先绑定69码或唯一编码: ' + $(this).text());
                return;
            }
            $('#pro_code').val(pro_code);
            $('.btn-pro-code').trigger('click');

        }).on('click', '.btn-clear', function (e) {
            $(this).parent().prev().val('');
        });

        table.on('click', '.btn-del', function (e) {
            table.bootstrapTable('remove', {
                field: 'product_id',
                values: [String($(this).data('pid'))]
            });
        }).on('mousedown', '.btn-stock-lock', function(){
            var _this = $(this);
            var id = String($(this).parent().parent().data('uniqueid'));
            var row = table.bootstrapTable('getRowByUniqueId', id);
            if(!row || !row.wh_stock || !row.wh_stock.replenish_warehouse){
                return false;
            }
            if(_this.data('loading') == 1 || _this.data('has-popover') == 1){
                return false;
            }
            _this.data('loading', 1);
            $.ajax({
                url: '/warehouse/stock_lock_info/',
                type: "POST",
                data: {replenish_warehouse: row.wh_stock.replenish_warehouse, product_id: row.product_id},
                dataType: 'json',
                success: function (resp) {
                    _this.data('loading', 0);
                    if (resp.status != 'y') {
                        alert(resp.msg);
                        return;
                    }
                    var _html = '';
                    for(var i in resp.data){
                        _html += '<div style="display: inline-block; margin-right: 10px"><a target="_blank" href="/deliver/shipping_view_order_products/'+resp.data[i]['id']+'" >'+resp.data[i]['name']+'</a>: <span style="color: red">'+resp.data[i]['add_qty']+'</span></div>'
                    }
                    if(_this.data('lockPurchase') > 0){
                        _html = '<div style="display: inline-block; margin-right: 10px; color: red">采购冻结: ' + _this.data('lockPurchase') + '</div>' +_html;
                    }
                    if(_this.data('has-popover') != 1){
                        _this.popover({
                            title: '冻结库存明细',
                            placement: 'top',
                            html: true,
                            content: '<div style="max-height: 200px; font-size: 11px;overflow-y:auto">' +_html + '</div>'
                        });
                        _this.popover('show');
                        _this.data('has-popover', 1);
                    }
                }

            });
            return false
        });

        toolBottom.on('click', '.btn-save', function (e) {
            if(!window.confirm('是否确认提交补货单？')){
                return;
            }

            var _this = $(this);
            var data = formData();
            if (_this.attr('loading') == 1) {
                return;
            }
            _this.attr('loading', 1);
            setTimeout(function () {
                data['equipment_id'] = "<{$equipment['id']}>";
                data['send_date'] = $('[name=send_date]').val();
                data['send_batch'] = $('[name=send_batch]').val();
                data['products'] = JSON.stringify(tableData());
                $.ajax({
                    url: '/deliver_order/replenish_save/',
                    type: "POST",
                    data: data,
                    dataType: 'json',
                    error: function () {
                        _this.attr('loading', 0);
                    },
                    success: function (resp) {
                        if (resp.status != 'y') {
                            MessageBox.error(resp.msg);
                            _this.attr('loading', 0);
                            return;
                        }
                        MessageBox.success('提交成功');
                        window.location.href = '/deliver/shipping';
                    }
                });
            }, 100);
        });
	    $('body').on('click', function(e){
            var target = $(e.target);
            var popo = $('[data-toggle="popover"]').not(target);
            var show_popo = popo.next();
            if(show_popo.length > 0 && target.parents('.popover.in').length === 0){
                show_popo.prev().popover('hide');
            }
        });

    })();
</script>