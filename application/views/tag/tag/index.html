<style type="text/css">
    td.name {
        max-width: 120px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    table{
        font-size: 13px;
    }
    td.code{
        line-height: 20px;
        height:64px;
        overflow: hidden;
        text-overflow:ellipsis;
        display: -webkit-box;
        -webkit-line-clamp:3;
        -webkit-box-orient: vertical;
    }
    td.code_w{
        max-width: 300px;
    }
</style>
<div class="panel panel-default">
    <div class="panel-heading">
        <h3 class="panel-title">标签管理(非rfid标签)</h3>
    </div>
    <div class="panel-body">
        <div class="form-horizontal" id="search">
            <div class="form-group">

                <div class="col-sm-2">
                    <select class="form-control" name="search_type">
                        <option value="-1">归属分类</option>
                        <{foreach key=key item=item from=$type}>
                        <option value="<{$key}>"><{$item}></option>
                        <{/foreach}>
                    </select>
                </div>
                <div class="col-sm-2">
                    <input type="text" class="form-control" name="search_name" placeholder="标签项">
                </div>
                <div class="col-sm-2">
                    <input type="text" class="form-control" name="search_value" placeholder="标签值">
                </div>
                <div class="col-sm-2">
                    <select class="form-control" name="search_status">
                        <option value="-1">状态</option>
                        <{foreach key=key item=item from=$status}>
                        <option value="<{$key}>"><{$item}></option>
                        <{/foreach}>
                    </select>
                </div>
                <div class="col-sm-2">
                    <button type="button" class="btn btn-default" id="search-btn">查找</button>
                </div>
            </div>

        </div>
    </div>
    <div class="panel-body">
        <div id="config-body">
            <table id="config-table" data-toggle="table" data-url="/tag/tag/table" data-sort-order="desc" data-pagination="true" data-side-pagination="server" data-page-list="[5,10,15,20]">
                <thead>
                <tr>
                    <th data-field="id" data-align="center" data-sortable="true" >ID</th>
                    <th data-field="type" data-align="center" >归属分类</th>
                    <th data-field="name" data-align="center">标签项</th>
                    <th data-field="value" data-align="center">标签值</th>
                    <th data-field="status" data-align="center">状态</th>
                    <th data-field="admin_name" data-align="center">更新人</th>
                    <th data-field="operation" data-align="center">操作</th>
                </tr>
                </thead>
            </table>
        </div>
    </div>


    <div class="panel-heading">
        <h3 class="panel-title">新增标签</h3>
    </div>
    <div class="panel-body">
        <form method="post" enctype="multipart/form-data" class="form-horizontal" action="/tag/tag/save_tag" onsubmit="return submit_model(this);">
            <div class="form-group">
                <label class="col-sm-2 control-label">归属标签：</label>
                <div class="col-sm-4">
                    <select class="form-control" name="type">
                        <{foreach key=key item=item from=$type}>
                        <option value="<{$key}>"><{$item}></option>
                        <{/foreach}>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-2 control-label">标签项：</label>
                <div class="col-sm-4">
                    <input type="text" class="form-control" name="name" placeholder="标签项">
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-2 control-label">标签值：</label>
                <div class="col-sm-4">
                    <input type="text" class="form-control" name="value[]" placeholder="标签值">
                </div>
                <label class="col-sm-1 control-label" style="color:green;font-size: 20px">
                    <i class="glyphicon-plus" onclick="ruleAdd(this)"></i>&nbsp;&nbsp;&nbsp;
                    <i class="glyphicon-minus" onclick="ruleDel(this)"></i>
                </label>
            </div>
            <div class="form-group">
                <label class="col-sm-2 control-label">状态：</label>
                <div class="col-sm-10">
                    <div class="checkbox">
                        <label>
                            <input type="radio" name="status" value="1" checked="checked">  启用
                        </label>
                        <label>
                            <input type="radio" name="status" value="2">  停用
                        </label>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <div class="col-sm-offset-2 col-sm-10">
                    <input class="btn btn-primary" type="submit" value="保存">
                </div>
            </div>
        </form>
    </div>
</div>

<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog" style="width: 800px">
        <div class="modal-content">


        </div><!-- /.modal-content -->
    </div><!-- /.modal -->
</div>


<script type="text/javascript">
    function ruleAdd(obj){
        var html = $(obj).parent().parent().clone();
        $(html).find("input[name='value[]']").val('');
        $(obj).parent().parent().after(html);
    }
    function ruleDel(obj){
        if($(obj).parent().parent().siblings().length<=4){
            return false;
        }
        $(obj).parent().parent().remove();
    }

    function submit_model(obj){
        var dataPara = getFormJson(obj);
        if(dataPara['name'] == ''){
            alert('标签项不能为空');
            return false;
        }
        if($(obj).attr('lock') == 1){
            return false;
        }
        $(obj).attr('lock', 1);
        ajaxSubmit(obj, function(data){
            $(obj).attr('lock', 0);
            if(data.status=='success'){
                MessageBox.success('新增成功');
                table_refer();
            }else{
                MessageBox.error(data.msg);
                return false;
            }
        });
        return false;
    }

    //将form转为AJAX提交
    function ajaxSubmit(frm, fn) {
        var dataPara = getFormJson(frm);
        $.ajax({
            url: frm.action,
            type: frm.method,
            data: dataPara,
            dataType:'json',
            success: fn
        });
    }

    //将form中的值转换为键值对。
    function getFormJson(frm) {
        var o = {};
        var a = $(frm).serializeArray();
        $.each(a, function () {
            if (o[this.name] !== undefined) {
                if (!o[this.name].push) {
                    o[this.name] = [o[this.name]];
                }
                o[this.name].push($.trim(this.value) || '');
            } else {
                o[this.name] = $.trim(this.value) || '';
            }
        });
        return o;
    }

    function update_status(id, status) {
        if (!id) {
            return false;
        }
        $.post("/tag/tag/update_status", {id: id, status:status}, function (data) {
            if (data.status == 'success') {
                MessageBox.success('修改成功');
                table_refer();
            }else{
                MessageBox.error('修改失败');
            }
        }, 'json');
    }

    function table_refer(){
        var serverUrl = '/tag/tag/table?';
        var filterData = "";
        $.each($("[name^='search_']"), function() {
            field = $(this).attr('name');
            data = $(this).val();
            if(data!=-1 && data!=""){
                filterData += field+"="+data+"&";
            }
        });
        if(filterData==""){
            var url = serverUrl;
        }else{
            var url = serverUrl +filterData;
        }
        $('#config-table').bootstrapTable('refresh', {url: url});
    }


    $(function(){
        $('#search-btn').click(function(){
            table_refer();
        });
    });

</script>